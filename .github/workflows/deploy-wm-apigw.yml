name: Deploy to wM API Gateway

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      api_specification: 
        required: true
        type: string
    secrets:
      API_GW_URL:
        required: true
        type: string
      API_GW_USERNAME:
        required: true
        type: string
      API_GW_PASSWORD:
        required: true
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      api-id: ${{ steps.find-api.outputs.api-id }}
      api-name: ${{ steps.compute.outputs.api-name }}
      api-version: ${{ steps.compute.outputs.api-version }} 
      api-is-active: ${{ steps.find-api.outputs.api-is-active }}
    steps:
      - name: Download API spec
        run: curl ${{ inputs.api_specification }} --output openapi.json
      - id: compute
        run: |
          API_NAME=$(jq '.info.title' openapi.json)
          API_VERSION=$(jq '.info.version' openapi.json)
          echo "::set-output name=api-name::${API_NAME}"
          echo "::set-output name=api-version::${API_VERSION}"
      - id: find-api
        uses: jiridj/wm-apigw-actions-find-api@v1
        with:
          apigw-url: ${{ secrets.API_GW_URL }}
          apigw-username: ${{ secrets.API_GW_USERNAME }}
          apigw-password: ${{ secrets.API_GW_PASSWORD }}
          api-name: ${{ steps.compute.outputs.api-name }}
          api-version: ${{ steps.compute.outputs.api-version }}
          fail-if-not-found: false
          
  create-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: [prepare]
    if: needs.prepare.outputs.api-id == ''
    steps:
      - id: create-api
        uses: jiridj/wm-apigw-actions-create-api@v1
        if: steps.find-api.outputs.api-id == ''
        with: 
          apigw-url: ${{ secrets.API_GW_URL }}
          apigw-user: ${{ secrets.API_GW_USERNAME }}
          apigw-password: ${{ secrets.API_GW_PASSWORD }}
          api-spec: 'openapi.json'
          api-spec-type: 'openapi'
      - id: activate-api
        uses: jiridj/wm-apigw-actions-activate-api@v1
        with:
          apigw-url: ${{ secrets.API_GW_URL }}
          apigw-user: ${{ secrets.API_GW_USERNAME }}
          apigw-password: ${{ secrets.API_GW_PASSWORD }}
          api-id: ${{ steps.find-api.outputs.api-id }}
          activate: true
          
  update-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: [prepare]
    if: needs.prepare.outputs.api-id == ''
    steps:
      - id: deactivate-api
        if: needs.prepare.outputs.api-is-active
        uses: jiridj/wm-apigw-actions-activate-api@v1
        with:
          apigw-url: ${{ secrets.API_GW_URL }}
          apigw-user: ${{ secrets.API_GW_USERNAME }}
          apigw-password: ${{ secrets.API_GW_PASSWORD }}
          api-id: ${{ needs.prepare.outputs.api-id }}
          activate: false
      - id: update-api
        uses: jiridj/wm-apigw-actions-update-api@v1
        if: steps.find-api.outputs.api-id != ''
        with: 
          apigw-url: ${{ secrets.API_GW_URL }}
          apigw-user: ${{ secrets.API_GW_USERNAME }}
          apigw-password: ${{ secrets.API_GW_PASSWORD }}
          api-id: ${{ needs.prepare.outputs.api-id }}
          api-spec: 'openapi.json'
          api-spec-type: 'openapi'
      - id: activate-api
        uses: jiridj/wm-apigw-actions-activate-api@v1
        with:
          apigw-url: ${{ secrets.API_GW_URL }}
          apigw-user: ${{ secrets.API_GW_USERNAME }}
          apigw-password: ${{ secrets.API_GW_PASSWORD }}
          api-id: ${{ needs.prepare.outputs.api-id }}
          activate: true
        
        